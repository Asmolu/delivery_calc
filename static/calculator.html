<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ü–µ–Ω—ã –∏ –¥–æ—Å—Ç–∞–≤–∫–∏</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background-color: #f5f7fb;
      margin: 0;
      padding: 0;
      color: #222;
    }
    h1 {
      text-align: center;
      font-size: 26px;
      margin: 25px 0;
    }
    .container {
      width: 90%;
      max-width: 850px;
      margin: 0 auto;
      background: white;
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    label {
      font-weight: 500;
      display: block;
      margin-top: 12px;
    }
    input, select, button {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-top: 5px;
      font-size: 15px;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 15px;
    }
    button:hover {
      background-color: #0056b3;
    }
    .product-block {
      background-color: #f1f5ff;
      border-radius: 10px;
      padding: 15px;
      margin-top: 10px;
    }
    .result-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.4);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .result-content {
      background: white;
      border-radius: 16px;
      padding: 25px;
      width: 90%;
      max-width: 900px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
      max-height: 90vh;
      overflow-y: auto;
    }
    .result-content h2 {
      margin-top: 0;
      color: #333;
      font-size: 22px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    .close-btn {
      float: right;
      cursor: pointer;
      font-size: 18px;
      color: #777;
    }
    .close-btn:hover {
      color: black;
    }
    .summary {
      margin-top: 15px;
      font-weight: 500;
      text-align: right;
    }
  </style>
</head>
<body>
  <div style="margin: 20px;">
    <button onclick="window.location.href='/static/index.html'" 
            style="background-color:#2980b9; color:white; border:none; padding:10px 16px;
                   border-radius:8px; cursor:pointer;">
      ‚Üê –ù–∞–∑–∞–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é
    </button>
  </div>

  <h1>üì¶ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ü–µ–Ω—ã –∏ –¥–æ—Å—Ç–∞–≤–∫–∏</h1>
  <div class="container">
    <label>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤—ã–≥—Ä—É–∑–∫–∏:</label>
    <input id="upload_coords" type="text" placeholder="55.616000, 37.387000" style="width: 100%;">
    <small>–í–≤–µ–¥–∏—Ç–µ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é: —à–∏—Ä–æ—Ç–∞, –¥–æ–ª–≥–æ—Ç–∞</small>

    <label>–¢–∏–ø —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞:</label>
    <select id="transport_type">
      <option value="auto">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞—Ç—å</option>
      <option value="manipulator">–ú–∞–Ω–∏–ø—É–ª—è—Ç–æ—Ä</option>
      <option value="long_haul">–î–ª–∏–Ω–Ω–æ–º–µ—Ä</option>
    </select>

    <label>–ó–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Ç–∏–ø—ã –º–∞—à–∏–Ω (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label>
    <input type="text" id="forbidden_types" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –º–∞–Ω–∏–ø—É–ª—è—Ç–æ—Ä">

    <h3>–¢–æ–≤–∞—Ä—ã –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞</h3>
    <div id="products"></div>
    <button onclick="addProduct()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –µ—â—ë —Ç–æ–≤–∞—Ä</button>
    <button onclick="calculate()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
  </div>

  <div class="result-modal" id="resultModal">
    <div class="result-content">
      <span class="close-btn" onclick="closeModal()">√ó</span>
      <div id="results">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
  </div>
    <script>
  let productIndex = 0;

  // ====== ‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ ======
  function addProduct() {
    const container = document.getElementById("products");
    const block = document.createElement("div");
    block.className = "product-block";
    block.innerHTML = `
      <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
      <select id="category_${productIndex}" onchange="loadSubtypes(${productIndex})">
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
      </select>

      <label>–ü–æ–¥—Ç–∏–ø:</label>
      <select id="subtype_${productIndex}">
        <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
      </select>

      <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
      <input type="number" id="quantity_${productIndex}" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ" step="1" min="1">

      <button onclick="this.parentElement.remove()">–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
    `;

    container.appendChild(block);
    loadCategories(productIndex); // –∑–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ –±–ª–æ–∫–∞
    productIndex++;
  }

  // ======== üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ –ø–æ–¥—Ç–∏–ø–æ–≤ ========
  let categoryData = {};

  async function loadCategories(index = null) {
    if (Object.keys(categoryData).length === 0) {
      const res = await fetch("/api/categories");
      categoryData = await res.json();
    }

    const categorySelect = index
      ? document.getElementById(`category_${index}`)
      : document.getElementById("category");

    if (!categorySelect) return;
    categorySelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';

    for (const cat of Object.keys(categoryData)) {
      const opt = document.createElement("option");
      opt.value = cat;
      opt.textContent = cat;
      categorySelect.appendChild(opt);
    }
  }

  function loadSubtypes(index) {
    const cat = document.getElementById(`category_${index}`).value;
    const subtypeSelect = document.getElementById(`subtype_${index}`);
    subtypeSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ç–∏–ø</option>';

    if (cat && categoryData[cat]) {
      for (const sub of categoryData[cat]) {
        const opt = document.createElement("option");
        opt.value = sub;
        opt.textContent = sub;
        subtypeSelect.appendChild(opt);
      }
    }
  }

  // ======== üßÆ –†–∞—Å—á—ë—Ç ========
  async function calculate() {
    const coordsInput = document.getElementById("upload_coords").value.trim();
    let uploadLat = 0, uploadLon = 0;

    if (coordsInput.includes(",")) {
      const [latStr, lonStr] = coordsInput.split(",").map(s => s.trim());
      uploadLat = parseFloat(latStr);
      uploadLon = parseFloat(lonStr);
    }

    const transportType = document.getElementById("transport_type").value;
    const forbidden = document.getElementById("forbidden_types").value
      .split(",")
      .map(s => s.trim())
      .filter(Boolean);

    const items = [];
    for (let i = 0; i < productIndex; i++) {
      const category = document.getElementById(`category_${i}`);
      const subtype = document.getElementById(`subtype_${i}`);
      const quantity = document.getElementById(`quantity_${i}`);

      if (category && subtype && quantity && category.value && subtype.value && quantity.value) {
        items.push({
          category: category.value,
          subtype: subtype.value,
          quantity: parseInt(quantity.value)
        });
      }
    }

    if (!uploadLat || !uploadLon || items.length === 0) {
      alert("‚ùó –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ –¥–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä");
      return;
    }

    document.getElementById("resultModal").style.display = "flex";
    document.getElementById("results").innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";

    try {
      const res = await fetch("/quote", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          upload_lat: uploadLat,
          upload_lon: uploadLon,
          transport_type: transportType,
          forbidden_types: forbidden,
          items: items
        })
      });

      if (!res.ok) throw new Error(`–û—à–∏–±–∫–∞: ${res.status}`);

      const data = await res.json();
      renderResults(data);
    } catch (err) {
      console.error(err);
      document.getElementById("results").innerHTML =
        `<p style="color:red;">–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á—ë—Ç–µ</p>`;
    }
  }

  // ======== üìä –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ========
  function renderResults(data) {
    if (!data || !data.–¥–µ—Ç–∞–ª–∏ || data.–¥–µ—Ç–∞–ª–∏.length === 0) {
      document.getElementById("results").innerHTML = `<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</p>`;
      return;
    }

    let html = `<h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á—ë—Ç–∞</h2>`;

    if (data["—Ç–∏–ø_—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞"]) {
      const transportNames = {
        manipulator: "–ú–∞–Ω–∏–ø—É–ª—è—Ç–æ—Ä",
        long_haul: "–î–ª–∏–Ω–Ω–æ–º–µ—Ä"
      };
      html += `<p><b>üöõ –¢–∏–ø —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞:</b> ${transportNames[data["—Ç–∏–ø_—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞"]] || data["—Ç–∏–ø_—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞"]}</p>`;
    }

    if (data["–æ–±—â–∏–π_–≤–µ—Å"]) html += `<p><b>‚öñÔ∏è –û–±—â–∏–π –≤–µ—Å:</b> ${data["–æ–±—â–∏–π_–≤–µ—Å"]} —Ç</p>`;
    if (data["–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ_—Ä–µ–π—Å–æ–≤"]) html += `<p><b>üì¶ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–π—Å–æ–≤:</b> ${data["–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ_—Ä–µ–π—Å–æ–≤"]}</p>`;

    html += `
      <table>
        <thead>
          <tr>
            <th>–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</th>
            <th>–¢–æ–≤–∞—Ä</th>
            <th>–ú–∞—à–∏–Ω–∞</th>
            <th>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ (–∫–º)</th>
            <th>–ú–∞—Ç–µ—Ä–∏–∞–ª (‚ÇΩ)</th>
            <th>–î–æ—Å—Ç–∞–≤–∫–∞ (‚ÇΩ)</th>
            <th>–¢–∞—Ä–∏—Ñ</th>
            <th>–ò—Ç–æ–≥–æ (‚ÇΩ)</th>
          </tr>
        </thead>
        <tbody>
    `;

    for (const item of data.–¥–µ—Ç–∞–ª–∏) {
      html += `
        <tr>
          <td>${item.–∑–∞–≤–æ–¥ || "‚Äî"}</td>
          <td>${item.—Ç–æ–≤–∞—Ä || "‚Äî"}</td>
          <td>${item.–º–∞—à–∏–Ω–∞ || "‚Äî"}</td>
          <td>${item.—Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ_–∫–º?.toFixed(2) || 0}</td>
          <td>${item.—Å—Ç–æ–∏–º–æ—Å—Ç—å_–º–∞—Ç–µ—Ä–∏–∞–ª–∞?.toLocaleString("ru-RU") || 0}</td>
          <td>${item.—Å—Ç–æ–∏–º–æ—Å—Ç—å_–¥–æ—Å—Ç–∞–≤–∫–∏?.toLocaleString("ru-RU") || 0}</td>
          <td>${item.—Ç–∞—Ä–∏—Ñ || "‚Äî"}</td>
          <td>${item.–∏—Ç–æ–≥–æ?.toLocaleString("ru-RU") || 0}</td>
        </tr>
      `;
    }

    html += `
        </tbody>
      </table>
      <div class="summary">
        üí∞ <strong>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã:</strong> ${data.–æ–±—â–∞—è_—Å—Ç–æ–∏–º–æ—Å—Ç—å_–º–∞—Ç–µ—Ä–∏–∞–ª–∞?.toLocaleString("ru-RU") || 0} ‚ÇΩ<br>
        üöö <strong>–î–æ—Å—Ç–∞–≤–∫–∞:</strong> ${data.–æ–±—â–∞—è_—Å—Ç–æ–∏–º–æ—Å—Ç—å_–¥–æ—Å—Ç–∞–≤–∫–∏?.toLocaleString("ru-RU") || 0} ‚ÇΩ<br>
        üî• <strong>–ò—Ç–æ–≥–æ:</strong> ${data.–∏—Ç–æ–≥–æ?.toLocaleString("ru-RU") || 0} ‚ÇΩ
      </div>
    `;

    document.getElementById("results").innerHTML = html;
  }

  function closeModal() {
    document.getElementById("resultModal").style.display = "none";
  }
</script>

</body>
</html>