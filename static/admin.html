<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ê–¥–º–∏–Ω–∫–∞ ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞–º–∏ –∏ –º–∞—à–∏–Ω–∞–º–∏</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background-color: #f6f7fb;
      margin: 0;
      padding: 0;
      color: #222;
    }
    h1 {
      text-align: center;
      font-size: 28px;
      margin: 30px 0 10px;
    }
    .container {
      width: 90%;
      max-width: 900px;
      margin: 0 auto;
      background: white;
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    h2 {
      font-size: 22px;
      margin-top: 25px;
      border-left: 4px solid #3498db;
      padding-left: 10px;
      color: #333;
    }
    input, select, button {
      font-size: 15px;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      width: 100%;
      margin-bottom: 10px;
    }
    button {
      cursor: pointer;
      background-color: #3498db;
      color: white;
      border: none;
      transition: 0.3s;
    }
    button:hover {
      background-color: #2980b9;
    }
    .section {
      margin-top: 25px;
      border-top: 1px solid #eee;
      padding-top: 20px;
    }
    .success {
      color: #2ecc71;
      font-weight: 500;
    }
    .error {
      color: #e74c3c;
      font-weight: 500;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table th, table td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: left;
    }
    table th {
      background-color: #f0f2f5;
    }
    .table-block {
      margin-top: 30px;
    }
  </style>
</head>

<body>
  <div style="margin: 20px;">
    <button onclick="window.location.href='/static/index.html'" 
            style="background-color:#2980b9; color:white; border:none; padding:10px 16px;
                   border-radius:8px; cursor:pointer;">
      ‚Üê –ù–∞–∑–∞–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é
    </button>
  </div>

  <h1>‚öôÔ∏è –ê–¥–º–∏–Ω–∫–∞ ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏</h1>
  <div class="container">

    <div class="section">
      <h2>–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</h2>
      <input type="text" id="factory_name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞">
      <input type="number" id="factory_lat" placeholder="–®–∏—Ä–æ—Ç–∞ (–ø—Ä–∏–º–µ—Ä: 55.85)" step="0.0001">
      <input type="number" id="factory_lon" placeholder="–î–æ–ª–≥–æ—Ç–∞ (–ø—Ä–∏–º–µ—Ä: 37.60)" step="0.0001">
      <button onclick="addFactory()">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</button>
      <div id="factory_msg"></div>
    </div>

    <!-- ===== –ë–ª–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–∞—à–∏–Ω—ã ===== -->
    <div class="section">
      <h2>–î–æ–±–∞–≤–∏—Ç—å –º–∞—à–∏–Ω—É</h2>

      <input type="text" id="vehicle_name"
             placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—à–∏–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: MAN TGS)">

      <input type="number" id="vehicle_capacity"
             placeholder="–ì—Ä—É–∑–æ–ø–æ–¥—ä—ë–º–Ω–æ—Å—Ç—å (—Ç–æ–Ω–Ω)" step="0.1">

      <label for="vehicle_tag" style="display:block; margin:6px 0 4px;">
        –¢–∏–ø –º–∞—à–∏–Ω—ã:
      </label>
      <select id="vehicle_tag">
        <option value="manipulator">–ú–∞–Ω–∏–ø—É–ª—è—Ç–æ—Ä</option>
        <option value="long_haul">–î–ª–∏–Ω–Ω–æ–º–µ—Ä</option>
      </select>

      <button onclick="addVehicle()" style="margin-top:10px;">
        –î–æ–±–∞–≤–∏—Ç—å –º–∞—à–∏–Ω—É
      </button>
      <div id="vehicle_msg"></div>
    </div>


    <div class="section">
      <h2>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä –∫ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤—É</h2>
      <select id="product_factory_select"></select>
      <input type="text" id="product_category" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: –î–æ—Ä–æ–∂–Ω—ã–µ –ø–ª–∏—Ç—ã)">
      <input type="text" id="product_subtype" placeholder="–ü–æ–¥—Ç–∏–ø (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ü–î–ù-30)">
      <input type="number" id="product_weight" placeholder="–í–µ—Å (—Ç–æ–Ω–Ω)" step="0.01">
      <input type="number" id="product_price" placeholder="–¶–µ–Ω–∞ (—Ä—É–±)" step="1">
      <button onclick="addProduct()">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
      <div id="product_msg"></div>
    </div>

        <div class="section">
      <h2>–£–¥–∞–ª–µ–Ω–∏–µ</h2>

      <label>–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ:</label>
      <select id="delete_factory_select"></select>
      <button onclick="deleteFactory()">–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</button>
      <div id="delete_factory_msg"></div>

      <label>–£–¥–∞–ª–∏—Ç—å –º–∞—à–∏–Ω—É:</label>
      <select id="delete_vehicle_select"></select>
      <button onclick="deleteVehicle()">–£–¥–∞–ª–∏—Ç—å –º–∞—à–∏–Ω—É</button>
      <div id="delete_vehicle_msg"></div>

      <label>–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä:</label>
      <select id="delete_product_factory_select"></select>
      <input type="text" id="delete_product_subtype" placeholder="–ü–æ–¥—Ç–∏–ø —Ç–æ–≤–∞—Ä–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è">
      <button onclick="deleteProduct()">–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
      <div id="delete_product_msg"></div>
    </div>

    <div class="section table-block">
      <h2>üìä –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ</h2>
      <div id="data_tables"></div>
    </div>
  </div>

  <script>
    // üîß –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫
    function formatError(data, defaultText = "–û—à–∏–±–∫–∞") {
      if (!data) return defaultText;
      if (typeof data === "string") return data;
      if (typeof data.detail === "string") return data.detail;
      if (typeof data.detail === "object") return JSON.stringify(data.detail);
      return defaultText;
    }

    // üîÅ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤
    async function refreshDropdowns() {
      document.body.style.cursor = "wait";
      try {
        const [factoriesRes, vehiclesRes] = await Promise.all([
          fetch("/api/factories"),
          fetch("/api/vehicles")
        ]);
        const factories = await factoriesRes.json();
        const vehicles = await vehiclesRes.json();

        const factorySelects = [
          document.getElementById("product_factory_select"),
          document.getElementById("delete_factory_select"),
          document.getElementById("delete_product_factory_select")
        ];
        factorySelects.forEach(sel => {
          sel.innerHTML = factories
            .map(f => `<option value="${f.name}">${f.name}</option>`)
            .join("");
        });

        const vehicleSelect = document.getElementById("delete_vehicle_select");
        vehicleSelect.innerHTML = vehicles
          .map(v => `<option value="${v.name}">${v.name}</option>`)
          .join("");

        renderDataTables(factories, vehicles);
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö:", err);
      } finally {
        document.body.style.cursor = "default";
      }
    }

    // üè≠ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞
    async function addFactory() {
      const name = factory_name.value.trim();
      const lat = parseFloat(factory_lat.value);
      const lon = parseFloat(factory_lon.value);
      const msg = factory_msg;
      msg.textContent = "";

      if (!name || isNaN(lat) || isNaN(lon)) {
        msg.textContent = "‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã.";
        msg.classList.add("error");
        return;
      }

      const res = await fetch("/api/factories", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, lat, lon })
      });
      const data = await res.json();

      if (res.ok) {
        msg.textContent = "‚úÖ " + (data.message || "–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!");
        msg.classList.remove("error");
        refreshDropdowns();
      } else {
        msg.textContent = "‚ö†Ô∏è " + formatError(data, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏");
        msg.classList.add("error");
      }
    }

    // üöö –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—à–∏–Ω—ã
async function addVehicle() {
  const name = document.getElementById("vehicle_name").value.trim();
  const capacity = parseFloat(document.getElementById("vehicle_capacity").value);
  const tag = document.getElementById("vehicle_tag").value;
  const msg = document.getElementById("vehicle_msg");
  msg.textContent = "";

  if (!name || isNaN(capacity) || !tag) {
    msg.textContent = "‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, –≥—Ä—É–∑–æ–ø–æ–¥—ä—ë–º–Ω–æ—Å—Ç—å –∏ —Ç–∏–ø –º–∞—à–∏–Ω—ã.";
    msg.classList.add("error");
    return;
  }

  const res = await fetch("/api/vehicles", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name, capacity_ton: capacity, tag })
  });

  const data = await res.json();
  if (res.ok) {
    msg.textContent = "‚úÖ " + data.message;
    msg.classList.remove("error");
    refreshDropdowns();
  } else {
    msg.textContent = "‚ö†Ô∏è " + (data.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –º–∞—à–∏–Ω—ã");
    msg.classList.add("error");
  }
}

// üì¶ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –∫ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤—É

    async function addProduct() {
      const factory = product_factory_select.value;
      const category = product_category.value.trim();
      const subtype = product_subtype.value.trim();
      const weight = parseFloat(product_weight.value);
      const price = parseFloat(product_price.value);
      const msg = product_msg;
      msg.textContent = "";

      if (!factory || !category || !subtype || isNaN(weight) || isNaN(price)) {
        msg.textContent = "‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.";
        msg.classList.add("error");
        return;
      }

      const res = await fetch(`/api/factories/${factory}/product`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ category, subtype, weight_ton: weight, price })
      });
      const data = await res.json();

      if (res.ok) {
        msg.textContent = "‚úÖ " + (data.message || "–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω!");
        msg.classList.remove("error");
        refreshDropdowns();
      } else {
        msg.textContent = "‚ö†Ô∏è " + formatError(data, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞");
        msg.classList.add("error");
      }
    }

    // üóë –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞
    async function deleteFactory() {
      const select = delete_factory_select;
      const name = select.value;
      const msg = delete_factory_msg;
      msg.textContent = "";

      if (!name) {
        msg.textContent = "‚ö†Ô∏è –ù–µ –≤—ã–±—Ä–∞–Ω–æ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ.";
        msg.classList.add("error");
        return;
      }

      const res = await fetch(`/api/factories/${name}`, { method: "DELETE" });
      const data = await res.json();

      if (res.ok) {
        msg.textContent = "‚úÖ " + (data.message || "–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ —É–¥–∞–ª–µ–Ω–æ!");
        msg.classList.remove("error");
        refreshDropdowns();
      } else {
        msg.textContent = "‚ö†Ô∏è " + formatError(data, "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");
        msg.classList.add("error");
      }
    }

    // üóë –£–¥–∞–ª–µ–Ω–∏–µ –º–∞—à–∏–Ω—ã
    async function deleteVehicle() {
      const name = delete_vehicle_select.value;
      const msg = delete_vehicle_msg;
      msg.textContent = "";

      if (!name) {
        msg.textContent = "‚ö†Ô∏è –ù–µ –≤—ã–±—Ä–∞–Ω–∞ –º–∞—à–∏–Ω–∞.";
        msg.classList.add("error");
        return;
      }

      const res = await fetch(`/api/vehicles/${name}`, { method: "DELETE" });
      const data = await res.json();

      if (res.ok) {
        msg.textContent = "‚úÖ " + (data.message || "–ú–∞—à–∏–Ω–∞ —É–¥–∞–ª–µ–Ω–∞!");
        msg.classList.remove("error");
        refreshDropdowns();
      } else {
        msg.textContent = "‚ö†Ô∏è " + formatError(data, "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–∞—à–∏–Ω—ã");
        msg.classList.add("error");
      }
    }

    // üóë –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
    async function deleteProduct() {
      const factory = delete_product_factory_select.value;
      const subtype = delete_product_subtype.value.trim();
      const msg = delete_product_msg;
      msg.textContent = "";

      if (!factory || !subtype) {
        msg.textContent = "‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –∏ –ø–æ–¥—Ç–∏–ø.";
        msg.classList.add("error");
        return;
      }

      const res = await fetch(`/api/factories/${factory}/product/${subtype}`, { method: "DELETE" });
      const data = await res.json();

      if (res.ok) {
        msg.textContent = "‚úÖ " + (data.message || "–¢–æ–≤–∞—Ä —É–¥–∞–ª—ë–Ω!");
        msg.classList.remove("error");
        refreshDropdowns();
      } else {
        msg.textContent = "‚ö†Ô∏è " + formatError(data, "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞");
        msg.classList.add("error");
      }
    }

    // üßæ –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
    function renderDataTables(factories, vehicles) {
      const container = document.getElementById("data_tables");
      let html = "";

      html += `<h3>üè≠ –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞</h3>`;
      if (factories.length === 0) {
        html += `<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞—Ö.</p>`;
      } else {
        html += `<table><thead><tr>
          <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</th><th>–¢–æ–≤–∞—Ä—ã</th>
        </tr></thead><tbody>`;
        factories.forEach(f => {
          const products = f.products?.length
            ? f.products.map(p => `${p.category} (${p.subtype}) ‚Äî ${p.price}‚ÇΩ / ${p.weight_ton}—Ç`).join("<br>")
            : "‚Äî";
          html += `<tr><td>${f.name}</td><td>${f.lat.toFixed(3)}, ${f.lon.toFixed(3)}</td><td>${products}</td></tr>`;
        });
        html += `</tbody></table>`;
      }

      html += `<h3>üöõ –ú–∞—à–∏–Ω—ã</h3>`;
      if (vehicles.length === 0) {
        html += `<p>–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –º–∞—à–∏–Ω.</p>`;
      } else {
        html += `<table><thead><tr>
          <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ì—Ä—É–∑–æ–ø–æ–¥—ä—ë–º–Ω–æ—Å—Ç—å (—Ç–æ–Ω–Ω)</th>
        </tr></thead><tbody>`;
        vehicles.forEach(v => {
          html += `<tr><td>${v.name}</td><td>${v.capacity_ton}</td></tr>`;
        });
        html += `</tbody></table>`;
      }

      container.innerHTML = html;
    }

    // üöÄ –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞
    window.onload = refreshDropdowns;
  </script>
</body>
</html>
